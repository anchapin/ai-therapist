# CI Test Environment - Mimics GitHub Actions Ubuntu Python 3.9
FROM ubuntu:22.04

# Install system dependencies
RUN apt-get update && apt-get install -y \
    software-properties-common \
    curl \
    portaudio19-dev \
    ffmpeg \
    libsndfile1 \
    && rm -rf /var/lib/apt/lists/*

# Add deadsnakes PPA for Python 3.9
RUN add-apt-repository ppa:deadsnakes/ppa -y && \
    apt-get update && \
    apt-get install -y python3.9 python3.9-pip python3.9-dev && \
    rm -rf /var/lib/apt/lists/*

# Create symbolic link for python3.9
RUN update-alternatives --install /usr/bin/python python /usr/bin/python3.9 1
RUN update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.9 1

# Set Python 3.9 as default
ENV PYTHONPATH=/usr/lib/python3.9/site-packages
ENV PATH=/usr/local/bin:/usr/bin:/bin

# Upgrade pip and install test dependencies
RUN python -m pip install --upgrade pip
RUN pip install pytest pytest-cov pytest-asyncio pytest-mock
RUN pip install coverage codecov

# Install core dependencies (same as CI)
RUN pip install langchain>=0.1.0 \
            langchain-community>=0.0.10 \
            langchain-text-splitters>=0.0.1 \
            langchain-openai>=0.0.5 \
            langchain-ollama>=0.1.0 \
            openai>=1.0.0 \
            faiss-cpu>=1.7.4 \
            pypdf>=3.17.0 \
            tiktoken>=0.5.0 \
            python-dotenv>=1.0.0 \
            streamlit>=1.28.0 \
            requests>=2.28.0 \
            numpy>=1.21.0 \
            scipy>=1.7.0 \
            pydantic>=2.5.0 \
            pyyaml>=6.0.1 \
            aiofiles>=23.2.1 \
            aiohttp>=3.9.0 \
            cryptography>=41.0.0 \
            bcrypt>=4.1.0

# Install psutil explicitly (missing in CI)
RUN pip install psutil>=5.9.0

# Install audio dependencies with error handling (same as CI)
RUN pip install librosa>=0.10.1 soundfile>=0.12.1 || echo "Some audio packages failed to install"
RUN pip install pyaudio>=0.2.11 || echo "PyAudio failed to install - will use mocks"

# Install remaining requirements
RUN pip install webrtcvad>=2.0.10 \
            pydub>=0.25.1 \
            ffmpeg-python>=0.2.0 \
            silero-vad>=0.3.0 \
            phonenumbers>=8.13.0 \
            num2words>=0.5.12 \
            python-multipart>=0.0.6 \
            jsonschema>=4.20.0 \
            openai-whisper>=20231117 \
            sounddevice>=0.4.6

# Set working directory
WORKDIR /app

# Copy application code
COPY . .

# Expose port for potential services
EXPOSE 8501

# Default command to run tests
CMD ["python", "tests/test_runner.py"]